{% extends 'base.html' %}
{% block title %}Raporlar - Kişisel Bütçe{% endblock %}

{% block content %}
<h1 class="mb-4">Grafik Raporları</h1>

<div class="row g-4">
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white">Aylık Gelir &amp; Gider</div>
      <div class="card-body">
        <canvas id="raporAylikChart" height="220"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white">Hesap Bazlı Bakiye</div>
      <div class="card-body">
        <canvas id="raporHesapChart" height="220"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white">Kategori Bazlı Gelir/Gider</div>
      <div class="card-body">
        <canvas id="raporKategoriGelirChart" height="220"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white">Kategori Bazlı Gider Payı</div>
      <div class="card-body">
        <canvas id="raporKategoriGiderChart" height="220"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  const raporAylikVeri = {{ aylik_veriler | tojson }};
  const kategoriDagilimi = {{ kategori_dagilimi | tojson }};
  const hesapDagilimi = {{ hesap_dagilimi | tojson }};
</script>
{% endblock %}

{% block extra_scripts %}
<script>
  const raporAylikCtx = document.getElementById('raporAylikChart');
  new Chart(raporAylikCtx, {
    type: 'line',
    data: {
      labels: raporAylikVeri.labels,
      datasets: [
        {
          label: 'Gelir',
          data: raporAylikVeri.gelir,
          borderColor: '#198754',
          backgroundColor: 'rgba(25, 135, 84, 0.1)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Gider',
          data: raporAylikVeri.gider,
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          fill: true,
          tension: 0.3
        }
      ]
    }
  });

  const raporHesapCtx = document.getElementById('raporHesapChart');
  new Chart(raporHesapCtx, {
    type: 'bar',
    data: {
      labels: hesapDagilimi.map(h => h.label),
      datasets: [{
        label: 'Bakiye',
        data: hesapDagilimi.map(h => h.value),
        backgroundColor: '#0dcaf0'
      }]
    },
    options: {
      plugins: { tooltip: { callbacks: { label: ctx => ctx.parsed.y + ' ₺' } } }
    }
  });

  const kategoriIsimleri = kategoriDagilimi.map(k => k.name);
  const kategoriRenkleri = kategoriDagilimi.map(k => 'var(--bs-' + k.color + ')');

  const gelirDataset = kategoriDagilimi.map(k => k.gelir);
  const giderDataset = kategoriDagilimi.map(k => k.gider);

  const raporKategoriGelirCtx = document.getElementById('raporKategoriGelirChart');
  new Chart(raporKategoriGelirCtx, {
    type: 'bar',
    data: {
      labels: kategoriIsimleri,
      datasets: [
        {
          label: 'Gelir',
          data: gelirDataset,
          backgroundColor: '#198754'
        },
        {
          label: 'Gider',
          data: giderDataset,
          backgroundColor: '#dc3545'
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  const raporKategoriGiderCtx = document.getElementById('raporKategoriGiderChart');
  new Chart(raporKategoriGiderCtx, {
    type: 'pie',
    data: {
      labels: kategoriIsimleri,
      datasets: [{
        data: giderDataset,
        backgroundColor: kategoriRenkleri
      }]
    }
  });
</script>
{% endblock %}
