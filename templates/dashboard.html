{% extends 'base.html' %}
{% block title %}Dashboard - Kişisel Bütçe{% endblock %}

{% block content %}
<h1 class="mb-4">Genel Bakış</h1>
<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="text-muted">Toplam Gelir</h6>
        <h3 class="text-success">{{ gelirler | round(2) }} {{ default_currency_symbol }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="text-muted">Toplam Gider</h6>
        <h3 class="text-danger">{{ giderler | round(2) }} {{ default_currency_symbol }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="text-muted">Net Bakiye</h6>
        <h3 class="text-primary">{{ net_bakiye | round(2) }} {{ default_currency_symbol }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="text-muted">En Çok Harcama Yapılan Kategori</h6>
        {% if en_cok_harcanan %}
          <span class="badge bg-{{ en_cok_harcanan.color }}">{{ en_cok_harcanan.name }}</span>
          <h4 class="mt-2">{{ en_cok_harcanan.toplam | round(2) }} {{ default_currency_symbol }}</h4>
        {% else %}
          <p class="text-muted">Henüz veri yok.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if kategori_limit_durumlari %}
<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <span>Aylık Kategori Limitleri</span>
        {% if limit_uyarilari %}
        <span class="badge bg-danger">{{ limit_uyarilari|length }} limit uyarısı</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if limitli_kategoriler %}
        <div class="list-group list-group-flush">
          {% for durum in limitli_kategoriler %}
          {% set kategori = durum.kategori %}
          {% set limit = durum.limit or 0 %}
          {% set oran = (durum.aylik_harcama / limit * 100) if limit > 0 else (100 if durum.limit_asildi else 0) %}
          {% set gosterge = oran if oran < 100 else 100 %}
          <div class="list-group-item px-0">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold">{{ kategori.name }}</div>
                <small class="text-muted">Limit: {{ limit | round(2) }} {{ default_currency_symbol }}</small>
              </div>
              <div class="text-end">
                <div class="fw-semibold {% if durum.limit_asildi %}text-danger{% else %}text-body{% endif %}">
                  {{ durum.aylik_harcama | round(2) }} {{ default_currency_symbol }}
                </div>
                {% if durum.limit_asildi %}
                <small class="text-danger">{{ (durum.aylik_harcama - limit) | round(2) }} {{ default_currency_symbol }} fazla</small>
                {% else %}
                <small class="text-muted">Kalan: {{ durum.kalan_limit | round(2) }} {{ default_currency_symbol }}</small>
                {% endif %}
              </div>
            </div>
            <div class="progress mt-2" style="height: 6px;">
              <div class="progress-bar {% if durum.limit_asildi %}bg-danger{% else %}bg-primary{% endif %}" role="progressbar" style="width: {{ gosterge | round(0, 'floor') }}%;"></div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-0">Henüz aylık limit tanımlanmış kategori bulunmuyor.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row g-4">
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white">Son 30 Gün Net Bakiye Trend</div>
      <div class="card-body">
        <canvas id="trendChart" height="220"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white">Hesap Bakiyeleri</div>
      <div class="card-body">
        <canvas id="hesapChart" height="220"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-lg-5">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <span>Bu Ayın Harcama Duyguları</span>
        <span class="badge bg-secondary">{{ duygu_ozeti|length }}</span>
      </div>
      <div class="card-body">
        {% if duygu_ozeti %}
        <div class="list-group list-group-flush">
          {% for item in duygu_ozeti %}
          <div class="list-group-item px-0 d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">{{ item.label }}</div>
              <small class="text-muted">{{ item.adet }} harcama</small>
            </div>
            <div class="text-end">
              <div class="fw-semibold text-danger">{{ item.toplam | round(2) }} {{ default_currency_symbol }}</div>
              <small class="text-muted">Ortalama: {{ item.ortalama | round(2) }}</small>
            </div>
          </div>
          {% endfor %}
        </div>
        <p class="text-muted small mb-0 mt-3">Duygu etiketlerini gelir/gider formlarından seçerek davranışsal harcama trendlerini izleyin.</p>
        {% else %}
        <p class="text-muted mb-0">Bu ay için etiketlenmiş harcama bulunmuyor.</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white">Akıllı Tasarruf Planlayıcısı</div>
      <div class="card-body">
        <form action="{{ url_for('create_savings_goal') }}" method="post" class="row g-3">
          <div class="col-md-5">
            <label class="form-label">Hedef Adı</label>
            <input type="text" name="name" class="form-control" placeholder="Örn. Tatil Fonu" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Hedef Tutar</label>
            <div class="input-group">
              <input type="number" min="0" step="0.01" name="target_amount" class="form-control" required>
              <span class="input-group-text">{{ default_currency_symbol }}</span>
            </div>
          </div>
          <div class="col-md-2">
            <label class="form-label">Başlangıç</label>
            <input type="date" name="start_date" class="form-control" value="{{ now().strftime('%Y-%m-%d') }}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Hedef Tarih</label>
            <input type="date" name="target_date" class="form-control" required>
          </div>
          <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary">Plan Oluştur</button>
          </div>
        </form>
        <hr>
        {% if tasarruf_planlari %}
        <div class="d-flex flex-column gap-3">
          {% for plan in tasarruf_planlari %}
          <div class="border rounded-3 p-3 bg-body-tertiary">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="mb-1">{{ plan.name }}</h5>
                <small class="text-muted">{{ plan.start_date | turkish_date }} → {{ plan.target_date | turkish_date }}</small>
              </div>
              <div class="text-end">
                {% if plan.is_completed %}
                <span class="badge bg-success">Tamamlandı</span>
                {% else %}
                <span class="badge bg-primary">%{{ plan.progress | round(1) }}</span>
                {% endif %}
              </div>
            </div>
            <div class="progress my-3" style="height: 8px;">
              <div class="progress-bar {% if plan.is_completed %}bg-success{% else %}bg-primary{% endif %}" style="width: {{ plan.progress | round(0, 'floor') }}%;" role="progressbar" aria-valuenow="{{ plan.progress | round(0, 'floor') }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="d-flex justify-content-between small text-muted">
              <span>Biriktirilen: {{ plan.net_savings | round(2) }} {{ default_currency_symbol }}</span>
              <span>Kalan: {{ plan.remaining_amount | round(2) }} {{ default_currency_symbol }}</span>
            </div>
            <ul class="list-unstyled small mb-0 mt-2">
              <li>Önerilen aylık hedef: {{ plan.recommended_monthly | round(2) }} {{ default_currency_symbol }} ({{ plan.total_months }} ay)</li>
              <li>Gerçekleşen ortalama aylık: {{ plan.actual_monthly | round(2) }} {{ default_currency_symbol }}</li>
              <li>Kalan gün: {{ plan.remaining_days }}</li>
            </ul>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                {% if plan.unlocked_milestones %}
                {% for milestone in plan.unlocked_milestones %}
                <span class="badge bg-{{ milestone.variant }} me-1">%{{ milestone.threshold }}</span>
                {% endfor %}
                {% endif %}
              </div>
              <form action="{{ url_for('delete_savings_goal', goal_id=plan.id) }}" method="post" onsubmit="return confirm('Hedefi silmek istediğinize emin misiniz?');">
                <button type="submit" class="btn btn-sm btn-outline-danger">Sil</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-0">Henüz tanımlı tasarruf hedefiniz yok. İlk hedefinizi oluşturup birikim rotanızı planlayın.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if kilit_mesajlari %}
<div class="row g-4 mt-1">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">Açılan Kilitler &amp; İpuçları</div>
      <div class="card-body">
        <div class="row g-3">
          {% for mesaj in kilit_mesajlari %}
          <div class="col-md-6 col-xl-3">
            <div class="alert alert-{{ mesaj.variant }} h-100 mb-0">
              <h6 class="alert-heading mb-2">%{{ mesaj.threshold }} • {{ mesaj.goal_name }}</h6>
              <p class="small mb-0">{{ mesaj.message }}</p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row g-4 mt-1">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">Aylık Gelir &amp; Gider Dağılımı</div>
      <div class="card-body">
        <canvas id="aylikChart" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  const trendVerisi = {{ trend_verisi | tojson }};
  const hesapVerisi = {{ hesap_bakiyeleri | tojson }};
  const aylikVeri = {{ aylik_veriler | tojson }};
</script>
{% endblock %}

{% block extra_scripts %}
<script>
  // Son 30 günlük trend çizgisi
  const trendCtx = document.getElementById('trendChart');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: trendVerisi.map(i => i.tarih),
      datasets: [{
        label: 'Net Değişim',
        data: trendVerisi.map(i => i.tutar),
        fill: true,
        borderColor: '#0d6efd',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });

  // Hesap bazlı bakiyeler
  const hesapCtx = document.getElementById('hesapChart');
  new Chart(hesapCtx, {
    type: 'bar',
    data: {
      labels: hesapVerisi.map(i => i.hesap),
      datasets: [{
        label: 'Bakiye',
        data: hesapVerisi.map(i => i.bakiye),
        backgroundColor: '#20c997'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => ctx.parsed.y + ' {{ default_currency_symbol }}' } }
      }
    }
  });

  // Aylık gelir & gider
  const aylikCtx = document.getElementById('aylikChart');
  new Chart(aylikCtx, {
    type: 'bar',
    data: {
      labels: aylikVeri.labels,
      datasets: [
        {
          label: 'Gelir',
          data: aylikVeri.gelir,
          backgroundColor: '#198754'
        },
        {
          label: 'Gider',
          data: aylikVeri.gider,
          backgroundColor: '#dc3545'
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { stacked: false },
        y: { beginAtZero: true }
      }
    }
  });
</script>
{% endblock %}
